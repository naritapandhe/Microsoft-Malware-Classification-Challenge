from pyspark.sql import SparkSession
from pyspark.ml.linalg import SparseVector, VectorUDT, Vectors
from pyspark.sql.types import *
from pyspark.ml.feature import VectorAssembler
from pyspark.ml.feature import ChiSqSelector
from pyspark.ml.classification import RandomForestClassifier
from preprocessing_bytes import preprocessor_bytes
from preprocessing_asm import preprocessor_asm

#initialize spark session
spark = SparkSession\
        .builder\
        .appName("Malware Random Forests")\
        .getOrCreate()
sc = spark.sparkContext

#paths to training data
X_file = "./data/X_train.txt"
y_file = "./data/y_train.txt"
X_file = sc.textFile(X_file,40)
y_file = sc.textFile(y_file,40)

#get asm features
preprocessor1 = preprocessor_asm()
hashes_and_labels = preprocessor1.hashes_and_labels(X_file,y_file)
s3_path = preprocessor1.get_s3_path(X_file)
metadata = sc.wholeTextFiles(','.join(s3_path),20)
asm = preprocessor1.transform(metadata,hashes_and_labels)

#paths to test data
X_file = "./data/X_test.txt"
X_file = sc.textFile(X_file,40)

#preprocess data
preprocessor2 = preprocessor()
test = preprocessor2.transform(X_file)

#rf classifier
rf = RandomForestClassifier(numTrees=100,maxDepth=8,seed=42)
model = rf.fit(train)
result = model.transform(test)

#save to csv
result.select("prediction").toPandas().astype(int).to_csv('prediction.csv',header=False,index=False)

spark.stop()
