from pyspark.sql import SparkSession
from pyspark.mllib.linalg import SparseVector, VectorUDT, Vectors
from pyspark.sql.types import *
from pyspark.ml.classification import RandomForestClassifier
from pyspark.ml.evaluation import MulticlassClassificationEvaluator
from preprocessing_aws_alt import preprocessor

#initialize spark session
spark = SparkSession\
        .builder\
        .appName("Malware Random Forests")\
        .getOrCreate()
sc = spark.sparkContext

#paths to training data
X_file = "./data/X_train.txt"
y_file = "./data/y_train.txt"
X_file = sc.textFile(X_file)
y_file = sc.textFile(y_file)

#preprocess data
preprocessor1 = preprocessor()
train = preprocessor1.transform(X_file,y_file)
   
#paths to test data
X_file = "./data/X_test.txt"
X_file = sc.textFile(X_file)

#preprocess data
preprocessor2 = preprocessor()
test = preprocessor2.transform(X_file)

#rf classifier
rf = RandomForestClassifier(numTrees=100)
model = rf.fit(train)
result = model.transform(test)

#save to csv
result.select("prediction").toPandas().to_csv('prediction.csv',header=False,index=False)

spark.stop()
